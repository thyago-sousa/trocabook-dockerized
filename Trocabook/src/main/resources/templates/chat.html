<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" type="text/css" href="/css/style.css"/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <title>Chat | Trocabook</title>
</head>
<body>
<div class="container">
    <header>
        <div class="wrapper">
            <table class="cabecalho">
                <tr>
                    <th id="cabecalhoelementos">
                        <a href="/"><img src="/img/Design sem nome (7).svg"></a>
                        <div class="autocomplete-wrapper">
                            <input type="text" style="width: 100%; height: 35px;" id="pesquisa" placeholder="Pesquisar">
                            <div id="resultadosPesquisa" class="sugestoes-autocomplete"></div>
                        </div>

                        <select id="inputCategoria" class="form-control" style="width: 200px; height:37px; margin-left: 15px;">
                            <option selected>Categoria...</option>
                            <option>Ação</option>
                            <option>Romance</option>
                            <option>Literatura</option>
                            <option>Lógica de Programação</option>
                            <option>Direito</option>
                            <option>Suspense</option>
                            <option>Ficção Científica</option>
                        </select>

                        <th:block sec:authorize="isAuthenticated()">
                            <a class="anunciar-livro4" href="/AnunciarLivro">Anunciar Livro</a>
                            <a class="meus-livros4" href="/MeusLivros">Meus Livros</a>
                            <form th:action="@{/logout}" method="post" style="display: inline;">
                                <button type="submit" id="deslogar">Sair</button>
                            </form>
                        </th:block>
                    </th>
                </tr>
            </table>
        </div>
    </header>

    <div vw class="enabled">
    </div>
    <script src="https://vlibras.gov.br/app/vlibras-plugin.js"></script>
    <script>
        new window.VLibras.Widget('https://vlibras.gov.br/app');
    </script>

    <main class="main-container">
        <aside class="chat-sidebar">
            <h2>Chat</h2>
            <input type="text" placeholder="Pesquisar conversas">
            <ul class="chat-list">
                <li class="active"><img th:src="${usuarioNegociante.foto}" alt="User"><span th:text="${usuarioNegociante.nmUsuario}"></span></li>
            </ul>
        </aside>

        <section class="chat-window">
            <div class="chat-info">
                <p style="text-align: center; color: #888; margin-bottom: 20px;">Lembre-se de trocar mensagens com respeito e cordialidade.<br>Desejamos uma excelente negociação :D</p>
            </div>

            <div class="messages" id="messagesContainer">
                <div th:each="msg : ${mensagens}"
                     th:class="'message ' + (${msg.cdUsuarioRemetente == usuarioLogado.cdUsuario} ? 'user' : 'negociador')">

                    <img th:if="${msg.cdUsuarioRemetente != usuarioLogado.cdUsuario}"
                         th:src="${usuarioNegociante.foto}" alt="Negociante">

                    <p th:text="${msg.conteudo}"></p>
                </div>
            </div>

            <form id="chatForm" class="message-input">
                <input type="hidden" id="cdUsuarioLivro" th:value="${mensagemDTO.cdUsuarioLivro}">
                <input type="hidden" id="cdUsuarioRemetente" th:value="${mensagemDTO.cdUsuarioRemetente}">
                <input type="hidden" id="cdUsuarioDestinatario" th:value="${mensagemDTO.cdUsuarioDestinatario}">
                <input type="text" id="conteudo" placeholder="Mensagem">
                <button type="submit"><img src="/img/aviao.png" alt="Enviar"></button>
            </form>
        </section>

        <aside class="book-info">
            <img th:src="${livro.capa}" alt="Capa O Pequeno Príncipe">
            <p><strong>Título da obra:</strong><br><b><span th:text="${livro.nmLivro}"></span></b></p>
            <p><strong>Data de publicação:</strong><br>15 de novembro de 2024</p>
            <p>Livro em ótimo estado, disponibilizo para vendas</p>
        </aside>
    </main>

    <script>
        const cdUsuarioLivro = parseInt(document.getElementById('cdUsuarioLivro').value);
        const cdUsuarioRemetente = parseInt(document.getElementById('cdUsuarioRemetente').value);
        const cdUsuarioDestinatario = parseInt(document.getElementById('cdUsuarioDestinatario').value);
        const container = document.getElementById('messagesContainer');
        let ultimaQuantidade = container.children.length;

        // Função para renderizar uma mensagem
        function adicionarMensagemNoContainer(msg) {
            const classe = msg.cdUsuarioRemetente === cdUsuarioRemetente ? 'user' : 'negociador';

            const img = msg.cdUsuarioRemetente === cdUsuarioRemetente
                ? ''
                : `<img src="${document.querySelector('.chat-list img')?.src || '/img/user.png'}" alt="Negociante">`;

            const div = document.createElement('div');
            div.className = `message ${classe}`;
            div.innerHTML = `${img}<p>${msg.conteudo}</p>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            ultimaQuantidade++;
        }

        // Envio de mensagem
        document.querySelector('#chatForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const conteudo = document.getElementById('conteudo').value.trim();
            if (!conteudo) return;

            const mensagem = {
                cdUsuarioLivro,
                cdUsuarioRemetente,
                cdUsuarioDestinatario,
                conteudo
            };

            const resposta = await fetch('/chat/mensagens', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(mensagem)
            });

            const data = await resposta.json();
            if (data.status === 'success') {
                adicionarMensagemNoContainer(data.data);
                document.getElementById('conteudo').value = '';
            }
        });

        // Atualização automática de mensagens (polling)
        async function atualizarMensagens() {
            const resp = await fetch(`/chat/mensagens/atualizar?usuarioLivro=${cdUsuarioLivro}&remetente=${cdUsuarioRemetente}&destinatario=${cdUsuarioDestinatario}`);
            const data = await resp.json();

            if (data.status === 'success') {
                if (data.data.length > ultimaQuantidade) {
                    const novas = data.data.slice(ultimaQuantidade);
                    novas.forEach(adicionarMensagemNoContainer);
                }
            }
        }

        // Atualiza a cada 4 segundos
        setInterval(atualizarMensagens, 4000);
    </script>

    <footer>
        <div class="rodapenovo">
            <a href="/"><img src="/img/Design sem nome.svg"></a>
            <a href="/sobreNos"><p>Conheça nosso incrível projeto <br>de incentivo a reutilização</p></a>
            <a href="/ajuda"><p>Central de ajuda</p></a>
            <small>© 2025 Sistema Trocabook<br>Todos os direitos reservados</small>
        </div>
    </footer>
</div>
</body>
<script src="/js/fetch.js"></script>
</html>